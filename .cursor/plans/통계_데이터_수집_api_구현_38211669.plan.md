---
name: 통계 데이터 수집 API 구현
overview: 통계 대시보드용 데이터 수집 API를 구현합니다. 지역별/타입별 관광지 개수를 집계하고, 전체 통계 요약을 제공하며, 병렬 처리와 캐싱을 통해 성능을 최적화합니다.
todos: []
---

# 통계 데이터 수집 API 구현

## 작업 범위

`lib/api/stats-api.ts` 파일을 생성하여 통계 대시보드에 필요한 데이터 수집 함수들을 구현합니다.

## 구현 내용

### 1. 타입 정의: `lib/types/stats.ts`

통계 관련 타입 정의를 생성합니다:

- **`RegionStats` 인터페이스**:
- `code`: 지역 코드 (string)
- `name`: 지역명 (string)
- `count`: 관광지 개수 (number)

- **`TypeStats` 인터페이스**:
- `contentTypeId`: 콘텐츠 타입 ID (string)
- `name`: 타입명 (string, 한글)
- `count`: 관광지 개수 (number)

- **`StatsSummary` 인터페이스**:
- `totalCount`: 전체 관광지 수 (number)
- `topRegions`: Top 3 지역 (RegionStats[])
- `topTypes`: Top 3 타입 (TypeStats[])
- `lastUpdated`: 마지막 업데이트 시간 (Date)

### 2. 파일 생성: `lib/api/stats-api.ts`

#### 2.1 `getRegionStats()` 함수

- **기능**: 각 시/도별 관광지 개수 집계
- **구현 방식**:
- `getAreaCode()`로 시/도 목록 조회
- 각 지역 코드별로 `getAreaBasedListWithPagination()` 호출
- `pagination.totalCount`를 사용하여 개수만 조회 (numOfRows: 1로 최소화)
- `Promise.all()`로 병렬 처리
- **반환값**: `RegionStats[]` (지역 코드, 지역명, 개수)
- **에러 처리**: 개별 지역 조회 실패 시 해당 지역은 제외하고 계속 진행

#### 2.2 `getTypeStats()` 함수

- **기능**: 각 콘텐츠 타입별 관광지 개수 집계
- **구현 방식**:
- `CONTENT_TYPE` 상수 사용 (12, 14, 15, 25, 28, 32, 38, 39)
- 각 contentTypeId별로 `getAreaBasedListWithPagination()` 호출
- `pagination.totalCount`를 사용하여 개수만 조회
- `Promise.all()`로 병렬 처리
- **반환값**: `TypeStats[]` (타입 ID, 타입명, 개수)
- **타입명 변환**: `CONTENT_TYPE` ID를 한글 이름으로 변환 (기존 함수 재사용)

#### 2.3 `getStatsSummary()` 함수

- **기능**: 전체 통계 요약 정보 생성
- **구현 방식**:
- `getRegionStats()`와 `getTypeStats()`를 병렬 호출
- 전체 관광지 수: `getAreaBasedListWithPagination()`로 전체 조회 (areaCode, contentTypeId 없이)
- Top 3 지역: `getRegionStats()` 결과를 count 기준 내림차순 정렬 후 상위 3개
- Top 3 타입: `getTypeStats()` 결과를 count 기준 내림차순 정렬 후 상위 3개
- 마지막 업데이트 시간: 현재 시간 (Date.now())
- **반환값**: `StatsSummary`
- **성능 최적화**: 모든 API 호출을 `Promise.all()`로 병렬 처리

### 3. 성능 최적화

- **병렬 API 호출**: `Promise.all()` 사용
- **최소 데이터 조회**: `numOfRows: 1`로 설정하여 totalCount만 조회
- **에러 처리**: 개별 API 호출 실패 시 해당 항목만 제외하고 계속 진행
- **재시도 로직**: 기존 `fetchWithRetry()` 함수 활용 (tour-api.ts에 이미 구현됨)

### 4. 데이터 캐싱

- **Next.js 캐싱**: `export const revalidate = 3600` 설정 (1시간)
- **또는**: `unstable_cache` 사용하여 함수 레벨 캐싱
- **캐시 키**: 각 함수별로 고유한 키 사용

### 5. 에러 처리

- **개별 API 실패**: 해당 지역/타입만 제외하고 빈 배열 또는 0 반환
- **전체 실패**: Error throw
- **로깅**: `console.error`로 상세 에러 정보 기록

## 참고 파일

- [lib/api/tour-api.ts](lib/api/tour-api.ts): 기존 API 함수들, `getAreaBasedListWithPagination()`, `getAreaCode()` 사용
- [lib/types/tour.ts](lib/types/tour.ts): `AreaCode`, `CONTENT_TYPE` 상수, `PaginationMetadata` 타입 참고
- [app/page.tsx](app/page.tsx): API 호출 패턴 참고

## 디자인 참고

- [docs/PRD.md](docs/PRD.md): 통계 대시보드 요구사항 (2.6절)
- [docs/DESIGN.md](docs/DESIGN.md): 통계 페이지 레이아웃 (없으면 일반 레이아웃 원칙 적용)

## 구현 세부사항

### API 호출 최적화

각 지역/타입별로 `getAreaBasedListWithPagination()`를 호출하되:

- `numOfRows: 1`로 설정하여 최소한의 데이터만 조회
- `pageNo: 1`로 첫 페이지만 조회
- `pagination.totalCount`만 사용하여 실제 데이터는 불러오지 않음

### 타입명 변환

`CONTENT_TYPE` ID를 한글 이름으로 변환하는 함수는 기존 `tour-filters.tsx` 또는 `tour-card.tsx`에 있는 함수를 재사용하거나, `lib/types/tour.ts`에 유틸리티 함수로 추가.

### 지역 코드 목록

`getAreaCode()`로 시/도 목록을 조회하되, 상위 지역 코드가 없는 항목만 필터링 (시/도만, 시/군/구 제외).